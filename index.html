<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
 "http://www.w3.org/TR/html4/strict.dtd">

<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>Simple Draw</title>
	<meta name="generator" content="TextMate http://macromates.com/">
	<meta name="author" content="John Tubert">
	<script src="/socket.io/socket.io.js"></script>
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script>
	<script>
		var socket = io.connect('http://jtubert2.no.de/');
		var drawLayer;		
		var ctx;
		var drawLayerRemote;		
		var ctxRemote;
		var lineColor = "#000000";
		var lineColorRemote = "#000000";
		
		//socket.socket.sessionid
		
		function sendSocketMessage(name,object){
			//console.log(socket.clients().length);
			socket.emit(name, object);
		}

		function init(){
			drawLayer = document.getElementById('drawLayer');		
			ctx = drawLayer.getContext('2d');
			
			drawLayerRemote = document.getElementById('drawLayerRemote');		
			ctxRemote = drawLayerRemote.getContext('2d');
			
			drawBackg();
			drawLayer.addEventListener('mousedown', onMouseDown, false);		
			drawLayer.addEventListener('mouseup', onMouseUp, false);	
		}
		
		hex_to_decimal = function(hex) {
			return Math.max(0, Math.min(parseInt(hex, 16), 255));
		};
		css3color = function(color, opacity) {
			return 'rgba('+hex_to_decimal(color.substr(0,2))+','+hex_to_decimal(color.substr(2,2))+','+hex_to_decimal(color.substr(4,2))+','+opacity+')';
		};
		
					
		function drawBackg(){
			var backgctx = document.getElementById('backg').getContext('2d');
			backgctx.fillStyle = css3color("DDDDDD",1);
			backgctx.fillRect(0,0,500,500);				
		}			
		function onMouseDown(e){
			var x = e.clientX-drawLayer.offsetLeft;
			var y = e.clientY-drawLayer.offsetTop;
			ctx.lineWidth = 3;
			ctx.strokeStyle = lineColor;
			ctx.beginPath();
			ctx.moveTo(x,y);
			drawLayer.addEventListener('mousemove', onMove, false);	
			
			sendSocketMessage('down', { x:x,y:y,lc:lineColor});	
		}
		
		function onMouseDownRemote(x,y,lc){
			ctxRemote.lineWidth = 3;
			ctxRemote.strokeStyle = lc;
			ctxRemote.beginPath();
			ctxRemote.moveTo(x,y);
		}
		
		

		function eraseAll(){
			ctx.clearRect(0,0,500,500);
			//console.log();				
		}			


		function onMouseUp(e){
			drawLayer.removeEventListener('mousemove', onMove,false);
			//eraseAll();				
		}			

		function onMove(e) {				
			var x = e.clientX-drawLayer.offsetLeft;
			var y = e.clientY-drawLayer.offsetTop;				
			ctx.lineTo(x,y);						
			ctx.stroke();
			
			sendSocketMessage('move', {x:x,y:y});
									
		}
		
		function onMoveRemote(x, y){			
			ctxRemote.lineTo(x,y);						
			ctxRemote.stroke();
		}
		
		
		function createColorChips(){
			$(".chip").each(function(){
			    //console.log("createColorChips: "+$(this).attr("color"));
				$(this).css("background-color",$(this).attr("color"));
				$(this).css("border-style","solid");
				$(this).css("border-width","1px");
				$(this).css("border-color",$(this).attr("color"));				
				$(this).show();
			});			
			$(".chip").click(function(){
				var otherContents = $(this).parent().find(".chip").not($(this));		
				
				$(this).css("border-color","#000000");
				
				otherContents.css("border-color","#DDDDDD");
						
				
				lineColor = $(this).attr("color");
				
			});
		}
	
		$(document).ready(function(){			
			init(); 
			createColorChips();
			
			console.log("onReady");
			
			socket.on('down', function (data) {
				console.log(data);
				onMouseDownRemote(data.draw.x, data.draw.y, data.draw.lc);
			});
			
			socket.on('move', function (data) {
				console.log(data);
				onMoveRemote(data.draw.x, data.draw.y);
			});
		});
	</script>	
</head>
<body>
	<canvas id="backg" width='500' height='500' style='z-index:0;position:absolute'></canvas>
	<canvas id="drawLayer" width='500' height='500' style='z-index:2;position:absolute'></canvas>
	<canvas id="drawLayerRemote" width='500' height='500' style='z-index:1;position:absolute'></canvas>
	<input type="button" onclick="eraseAll()" value="ERASE ALL" style='z-index:3;position:relative'/>
	<div class="chip" color="#FF0000" style="z-index:4;width:20px; height:20px;position:relative">&nbsp;</div>
	<div class="chip" color="#00FF00" width="20px" height="20px" style='z-index:5;width:20px; height:20px;position:relative'>&nbsp;</div>
	<div class="chip" color="#0000FF" width="20px" height="20px" style='z-index:6;width:20px; height:20px;position:relative'>&nbsp;</div>

		
</body>
</html>
