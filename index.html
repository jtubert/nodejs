<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
 "http://www.w3.org/TR/html4/strict.dtd">

<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>Simple Draw</title>
	<meta name="generator" content="TextMate http://macromates.com/">
	<meta name="author" content="John Tubert">
	<script src="/socket.io/socket.io.js"></script>
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script>
	<!--script type="text/javascript" src="Stats.js"></script-->
	
	<style>
		body {
		   margin:0;
		   padding:0;
		   height:100%;
		}
		
		.mouse{
			background-image: url('http://localhost');
			position: absolute;
			background-repeat: no-repeat;
			height: 22px;
			min-width: 15px;
		}
		
		.nickname{
			position:relative;
			background:white;
			padding:3px;
			left:16px;
		}
		
		#footer {
		   position:absolute;
		   bottom:0;
		   width:100%;
		   height:40px;   /* Height of the footer */
		   background:#6cf;
		}		
	</style>
	
	<script>
		var socket = io.connect('http://thedrawingroom-jtubert.dotcloud.com/');
		var drawLayer;		
		var ctx;		
		var lineColor = "#000000";		
		
		var remoteLayerArray = {};
		var remoteCtxArray = {};
		var cursorsArray = {};
		var zindex = 0;
		
		//socket.socket.sessionid
		
		/*var stats = new Stats();

		// Align top-left
		stats.domElement.style.position = 'absolute';
		stats.domElement.style.left = '0px';
		stats.domElement.style.top = '0px';

		$("body").append( stats.domElement );

		setInterval( function () {

		    stats.update();

		}, 1000 / 60 );
		*/
		function sendSocketMessage(name,object){
			//console.log(socket.clients().length);
			socket.emit(name, object);
		}

		function init(){
			drawLayer = document.getElementById('drawLayer');		
			ctx = drawLayer.getContext('2d');
			
			//drawLayerRemote = document.getElementById('drawLayerRemote');		
			//ctxRemote = drawLayerRemote.getContext('2d');
			
			drawBackg();
			drawLayer.addEventListener('mousedown', onMouseDown, false);		
			drawLayer.addEventListener('mouseup', onMouseUp, false);	
		}
		
		hex_to_decimal = function(hex) {
			return Math.max(0, Math.min(parseInt(hex, 16), 255));
		};
		css3color = function(color, opacity) {
			return 'rgba('+hex_to_decimal(color.substr(0,2))+','+hex_to_decimal(color.substr(2,2))+','+hex_to_decimal(color.substr(4,2))+','+opacity+')';
		};
		
					
		function drawBackg(){
			var backgctx = document.getElementById('backg').getContext('2d');
			backgctx.fillStyle = css3color("DDDDDD",1);
			backgctx.fillRect(0,0,500,500);				
		}			
		function onMouseDown(e){
			var x = e.clientX-drawLayer.offsetLeft;
			var y = e.clientY-drawLayer.offsetTop;
			ctx.lineWidth = 3;
			ctx.strokeStyle = lineColor;
			ctx.beginPath();
			ctx.moveTo(x,y);
			drawLayer.addEventListener('mousemove', onMove, false);	
			
			sendSocketMessage('down', { x:x,y:y,lc:lineColor});	
		}
		
		function createCanvasObject(nickname,socketID){
			zindex++;
			remoteLayerArray[socketID] = $("<canvas style='top:0px;left:0px;position:absolute;z-index:" + zindex + "' id='" + socketID + "' width='500' height='500'></canvas>").appendTo("#drawModule");
			remoteLayerArray[socketID].nickname = nickname;		
			var layer = document.getElementById(socketID);
	        remoteCtxArray[socketID] = layer.getContext("2d");	
	
			cursorsArray[socketID] = $("<div style='position:absolute;z-index:"+(1000+zindex)+"' id='" + socketID + "'><span class='mouse'></span><div class='nickname'>"+nickname+"</div></div>").appendTo("#drawModule");
		
			//$("#users").html("Number of connected users: "+(zindex+1));
		}
		
		function onMouseDownRemote(x,y,lc,nickname,socketID){
			if(!remoteLayerArray[socketID]){
				createCanvasObject(nickname,socketID);
			}
			
			cursorsArray[socketID].show();
			
			remoteCtxArray[socketID].lineWidth = 3;
			remoteCtxArray[socketID].strokeStyle = lc;
			remoteCtxArray[socketID].beginPath();
			remoteCtxArray[socketID].moveTo(x,y);
		}	
		
		function erase(){
			ctx.clearRect(0,0,500,500);	
			for (socketID in remoteCtxArray){
				remoteCtxArray[socketID].clearRect(0,0,500,500);
			}
		}	

		function eraseAll(){
			erase();
			sendSocketMessage('erase', {});						
		}
		
		function eraseAllRemote(){
			erase();
		}

		function onMouseUp(e){
			drawLayer.removeEventListener('mousemove', onMove,false);
			sendSocketMessage('mouseup', {});					
		}
		
		function onMouseUpRemote(nickname,socketID){
			cursorsArray[socketID].hide();
		}			

		function onMove(e) {				
			var x = e.clientX-drawLayer.offsetLeft;
			var y = e.clientY-drawLayer.offsetTop;				
			ctx.lineTo(x,y);						
			ctx.stroke();
			
			sendSocketMessage('move', {x:x,y:y});
									
		}
		
		function onMoveRemote(x, y,nickname,socketID){			
			remoteCtxArray[socketID].lineTo(x,y);						
			remoteCtxArray[socketID].stroke();
			
			cursorsArray[socketID].css("left",x+"px");
			cursorsArray[socketID].css("top",y+"px");
		}
		
		
		function createColorChips(){
			$(".chip").each(function(){
			    //console.log("createColorChips: "+$(this).attr("color"));
				$(this).css("background-color",$(this).attr("color"));
				$(this).css("border-style","solid");
				$(this).css("border-width","1px");
				$(this).css("border-color",$(this).attr("color"));				
				$(this).show();
			});			
			$(".chip").click(function(){
				var otherContents = $(this).parent().find(".chip").not($(this));		
				
				$(this).css("border-color","#000000");
				
				otherContents.css("border-color","#DDDDDD");
						
				
				lineColor = $(this).attr("color");
				
			});
		}
		
		function join(){
			var n = $("#nickname").val();
			
			if(n.length > 0){
				if(n.length > 40){
					alert("Nickname is too long!");
				}else{
					sendSocketMessage("setName", $("#nickname").val());
					$("#joinModule").hide();
					$("#drawModule").show();
					//$("#users").html("Number of connected users: 1");
					
				}				
			}else{
				alert("enter a nickname!");
			}			
		}
	
		$(document).ready(function(){			
			init(); 
			createColorChips();
			
			console.log("onReady");
			
			socket.on('down', function (data) {
				//console.log(data);
				onMouseDownRemote(data.draw.x, data.draw.y, data.draw.lc,data.nickname,data.socketID);
			});
			
			socket.on('mouseup', function (data) {
				//console.log(data);
				onMouseUpRemote(data.nickname,data.socketID);
			});
			
			socket.on('move', function (data) {
				//console.log(data);
				onMoveRemote(data.draw.x, data.draw.y,data.nickname,data.socketID);
			});
			
			socket.on('erase', function (data) {
				eraseAllRemote();
			});
			
			socket.on('connect', function (data) {
				if(data && data.connections){
					$("#users").html("Number of connected users: "+data.connections);
				}				
			});
		});
	</script>	
</head>
<body>
	<div id="joinModule">
		<input type="text" id="nickname" value=""/>
		<input type="button" onclick="join()" value="JOIN"/>
	</div>
	
	<div id="drawModule" style="display:none">
		<canvas id="backg" width='500' height='500' style='z-index:0;position:absolute'></canvas>
		<canvas id="drawLayer" width='500' height='500' style='z-index:10000;position:absolute;top:0px;left:0px'></canvas>
		<input type="button" onclick="eraseAll()" value="ERASE ALL" style='z-index:10004;position:relative'/>
		<div class="chip" color="#FF0000" style="z-index:10001;width:20px; height:20px;position:relative">&nbsp;</div>
		<div class="chip" color="#00FF00" width="20px" height="20px" style='z-index:10002;width:20px; height:20px;position:relative'>&nbsp;</div>
		<div class="chip" color="#0000FF" width="20px" height="20px" style='z-index:10003;width:20px; height:20px;position:relative'>&nbsp;</div>
	</div>
	
	<div id="footer">
		<p id="users" style="padding-left:5px">Number of connected users: 0</p>
	</div>
		
</body>
</html>
